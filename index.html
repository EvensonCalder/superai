<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #000;
            color: #fff;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            padding: 20px;
            gap: 20px;
        }
        
        .result-section {
            flex: 3;
            background-color: #111;
            border-radius: 8px;
            padding: 20px;
            overflow-y: auto;
            position: relative;
        }
        
        .status-section {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
        }
        
        .status-circle {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #fff;
            transition: background-color 0.3s ease;
        }
        
        .status-circle.active {
            background-color: #3498db;
        }
        
        .status-circle.completed {
            background-color: #2ecc71;
        }
        
        .input-section {
            flex: 2;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .input-container {
            display: flex;
            gap: 10px;
        }
        
        #user-input {
            flex: 1;
            background-color: #111;
            border: 1px solid #333;
            color: #fff;
            padding: 12px;
            border-radius: 4px;
            font-size: 16px;
        }
        
        .button {
            background-color: #333;
            color: #fff;
            border: none;
            padding: 12px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s ease;
        }
        
        .button:hover {
            background-color: #555;
        }
        
        .copy-button {
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: #333;
            color: #fff;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            display: none;
            z-index: 10;
        }
        
        .result-section:hover .copy-button {
            display: block;
        }
        
        /* Markdown样式 */
        .markdown-content h1, .markdown-content h2, .markdown-content h3, 
        .markdown-content h4, .markdown-content h5, .markdown-content h6 {
            margin-top: 20px;
            margin-bottom: 10px;
            font-weight: bold;
        }
        
        .markdown-content p {
            margin-bottom: 16px;
            line-height: 1.6;
        }
        
        .markdown-content code {
            background-color: #222;
            padding: 2px 4px;
            border-radius: 3px;
            font-family: monospace;
        }
        
        .markdown-content pre {
            background-color: #222;
            padding: 16px;
            border-radius: 4px;
            overflow-x: auto;
            margin-bottom: 16px;
        }
        
        .markdown-content pre code {
            background-color: transparent;
            padding: 0;
        }
        
        .markdown-content ul, .markdown-content ol {
            margin-bottom: 16px;
            padding-left: 30px;
        }
        
        .markdown-content li {
            margin-bottom: 8px;
        }
        
        .markdown-content blockquote {
            border-left: 4px solid #555;
            padding-left: 16px;
            margin-bottom: 16px;
            color: #ccc;
        }
        
        .markdown-content table {
            border-collapse: collapse;
            width: 100%;
            margin-bottom: 16px;
        }
        
        .markdown-content th, .markdown-content td {
            border: 1px solid #444;
            padding: 8px 12px;
            text-align: left;
        }
        
        .markdown-content th {
            background-color: #222;
        }
        
        .markdown-content a {
            color: #3498db;
            text-decoration: none;
        }
        
        .markdown-content a:hover {
            text-decoration: underline;
        }
        
        /* 响应式设计 */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
                gap: 10px;
            }
            
            .status-circle {
                width: 30px;
                height: 30px;
            }
            
            .status-section {
                gap: 8px;
            }
            
            .button {
                padding: 10px 15px;
                font-size: 14px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="result-section" id="result-section">
            <button class="copy-button" id="copy-button">复制</button>
            <div class="markdown-content" id="markdown-content"></div>
        </div>
        
        <div class="status-section" id="status-section">
            <div class="status-circle" id="status-1"></div>
            <div class="status-circle" id="status-2"></div>
            <div class="status-circle" id="status-3"></div>
            <div class="status-circle" id="status-4"></div>
            <div class="status-circle" id="status-5"></div>
            <div class="status-circle" id="status-6"></div>
            <div class="status-circle" id="status-7"></div>
            <div class="status-circle" id="status-8"></div>
        </div>
        
        <div class="input-section">
            <div class="input-container">
                <input type="text" id="user-input" placeholder="请输入">
                <button class="button" id="clear-button">清空</button>
                <button class="button" id="download-button">下载</button>
                <button class="button" id="send-button">发送</button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <script>
        // 获取DOM元素
        const resultSection = document.getElementById('result-section');
        const markdownContent = document.getElementById('markdown-content');
        const copyButton = document.getElementById('copy-button');
        const userInput = document.getElementById('user-input');
        const clearButton = document.getElementById('clear-button');
        const downloadButton = document.getElementById('download-button');
        const sendButton = document.getElementById('send-button');
        
        // 状态圆圈
        const statusCircles = [];
        for (let i = 1; i <= 8; i++) {
            statusCircles.push(document.getElementById(`status-${i}`));
        }
        
        // 存储查询结果
        let queryResults = [];
        let bestAnswerIndex = -1;
        
        // 复制按钮功能
        copyButton.addEventListener('click', () => {
            if (bestAnswerIndex >= 0 && queryResults[bestAnswerIndex]) {
                navigator.clipboard.writeText(queryResults[bestAnswerIndex])
                    .then(() => {
                        const originalText = copyButton.textContent;
                        copyButton.textContent = '已复制';
                        setTimeout(() => {
                            copyButton.textContent = originalText;
                        }, 2000);
                    })
                    .catch(err => {
                        console.error('复制失败:', err);
                    });
            }
        });
        
        // 清空按钮功能
        clearButton.addEventListener('click', () => {
            userInput.value = '';
            markdownContent.innerHTML = '';
            queryResults = [];
            bestAnswerIndex = -1;
            
            // 重置所有状态圆圈
            statusCircles.forEach(circle => {
                circle.classList.remove('active', 'completed');
            });
        });
        
        // 下载按钮功能
        downloadButton.addEventListener('click', () => {
            if (bestAnswerIndex >= 0 && queryResults[bestAnswerIndex]) {
                const content = queryResults[bestAnswerIndex];
                const blob = new Blob([content], { type: 'text/markdown' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${Date.now()}.md`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }
        });
        
        // 发送按钮功能
        sendButton.addEventListener('click', async () => {
            const userQuestion = userInput.value.trim();
            if (!userQuestion) {
                return;
            }
            
            // 清空之前的结果
            markdownContent.innerHTML = '';
            queryResults = new Array(8).fill('');
            bestAnswerIndex = -1;
            
            // 重置所有状态圆圈
            statusCircles.forEach(circle => {
                circle.classList.remove('active', 'completed');
            });
            
            // 模型配置
            const modelConfigs = [
                { model: 'qwen3-think-search', temperature: 0.3 },
                { model: 'qwen3-think-search', temperature: 0.7 },
                { model: 'qwen3-think', temperature: 0 },
                { model: 'qwen3-think', temperature: 0.3 },
                { model: 'qwen3-nothink-search', temperature: 0.3 },
                { model: 'qwen3-nothink-search', temperature: 0.7 },
                { model: 'qwen3-nothink', temperature: 0 },
                { model: 'qwen3-nothink', temperature: 0.3 }
            ];
            
            // 发送8个请求，每个间隔1秒
            const promises = modelConfigs.map((config, index) => {
                return new Promise((resolve) => {
                    setTimeout(() => {
                        sendQuery(userQuestion, config.model, config.temperature, index)
                            .then(resolve);
                    }, index * 1000);
                });
            });
            
            // 等待所有请求完成
            await Promise.all(promises);
            
            // 发送评价请求
            sendEvaluationRequest(userQuestion);
        });
        
        // 发送查询请求
        async function sendQuery(question, model, temperature, index) {
            // 设置状态圆圈为活跃
            statusCircles[index].classList.add('active');
            
            const requestData = {
                messages: [
                    {
                        content: "Respond in markdown.",
                        role: "system"
                    },
                    {
                        content: question,
                        role: "user"
                    }
                ],
                model: model,
                stream: true,
                temperature: temperature,
                top_p: 0.9
            };
            
            try {
                const response = await fetch('https://gqtlstll.ap-northeast-1.clawcloudrun.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer sk-DYTJTO2umSLWzotPnU9vGOsWKPnE6SBM52ZOOLpDM6hqyOMq',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestData)
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let result = '';
                
                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    
                    const chunk = decoder.decode(value);
                    const lines = chunk.split('\n');
                    
                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            const data = line.substring(6);
                            if (data === '[DONE]') continue;
                            
                            try {
                                const json = JSON.parse(data);
                                const content = json.choices[0].delta.content;
                                if (content) {
                                    result += content;
                                }
                                
                                const finishReason = json.choices[0].finish_reason;
                                if (finishReason && finishReason !== 'null') {
                                    // 请求完成，设置状态圆圈为完成
                                    statusCircles[index].classList.remove('active');
                                    statusCircles[index].classList.add('completed');
                                    queryResults[index] = result;
                                    break;
                                }
                            } catch (e) {
                                console.error('Error parsing JSON:', e);
                            }
                        }
                    }
                }
            } catch (error) {
                console.error('Error sending query:', error);
                // 请求失败，重置状态圆圈
                statusCircles[index].classList.remove('active');
            }
        }
        
        // 发送评价请求
        async function sendEvaluationRequest(question) {
            // 构建查询字符串
            let queryStr = `用户的问题是：${question}\n`;
            for (let i = 0; i < 8; i++) {
                queryStr += `第 ${i + 1} 个回答：${queryResults[i]}\n`;
            }
            
            try {
                const response = await fetch('https://n8n-ujyltfyn.ap-northeast-1.clawcloudrun.com/webhook/judge', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        query: queryStr
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                bestAnswerIndex = parseInt(result.answerid) - 1; // 转换为0-based索引
                
                // 显示最佳答案
                if (bestAnswerIndex >= 0 && bestAnswerIndex < 8 && queryResults[bestAnswerIndex]) {
                    markdownContent.innerHTML = marked.parse(queryResults[bestAnswerIndex]);
                }
            } catch (error) {
                console.error('Error sending evaluation request:', error);
                // 如果评价请求失败，显示第一个答案
                if (queryResults[0]) {
                    markdownContent.innerHTML = marked.parse(queryResults[0]);
                }
            }
        }
    </script>
</body>
</html>
